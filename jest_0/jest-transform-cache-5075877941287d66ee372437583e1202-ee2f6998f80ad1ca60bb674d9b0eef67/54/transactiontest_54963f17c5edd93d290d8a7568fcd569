e7a70eee634e8179330d7b9f931c3e10
const Transaction = require("../wallet/transaction/index");

const Wallet = require("../wallet/index");

const {
  verifySignature
} = require("../utils");

describe("Transaction", () => {
  let transaction, senderWallet, receiver, amount;
  beforeEach(() => {
    senderWallet = new Wallet();
    receiver = "receiver-publicKey";
    amount = 20;
    transaction = new Transaction({
      senderWallet,
      receiver,
      amount
    });
  });
  it("has an `id`", () => {
    expect(transaction).toHaveProperty("id");
  });
  describe("outputMap", () => {
    it("has an outputMap", () => {
      expect(transaction).toHaveProperty("outputMap");
    });
    it("outputs amount of receiver", () => {
      expect(transaction.outputMap[receiver]).toEqual(amount);
    });
    it("outputs the remaining balance of the sender", () => {
      expect(transaction.outputMap[senderWallet.publicKey]).toEqual(senderWallet.balance - amount);
    });
  });
  describe("input", () => {
    it("has an `input`", () => {
      expect(transaction).toHaveProperty("input");
    });
    it("has `timestamp` in the `input`", () => {
      expect(transaction.input).toHaveProperty("timestamp");
    });
    it("sets the `amount` to the `senderWallet` balance", () => {
      expect(transaction.input.amount).toEqual(senderWallet.balance);
    });
    it("sets the `address` to the `senderWallet` publicKey", () => {
      expect(transaction.input.address).toEqual(senderWallet.publicKey);
    });
    it("signs the input", () => {
      expect(verifySignature({
        publicKey: senderWallet.publicKey,
        data: transaction.outputMap,
        signature: transaction.input.signature
      })).toBe(true);
    });
  });
  describe("validateTransaction()", () => {
    let errorMock;
    beforeEach(() => {
      errorMock = jest.fn();
      global.console.error = errorMock;
    });
    describe("when the transaction is valid", () => {
      it("returns true", () => {
        expect(Transaction.validateTransaction(transaction)).toBe(true);
      });
    });
    describe("when the transaction is invalid", () => {
      describe("and the transaction outputmap value is invalid", () => {
        it("returns false and logs an error", () => {
          transaction.outputMap[senderWallet.publicKey] = 999999;
          expect(Transaction.validateTransaction(transaction)).toBe(false);
          expect(errorMock).toHaveBeenCalled();
        });
      });
      describe("and the transaction input signature is invalid", () => {
        it("returns false and logs an error", () => {
          transaction.input.signature = new Wallet().sign("data");
          expect(Transaction.validateTransaction(transaction)).toBe(false);
          expect(errorMock).toHaveBeenCalled();
        });
      });
    });
  });
  describe("update()", () => {
    let originalSignature, originalSenderOutput, nexReceiver, nextAmount;
    beforeEach(() => {
      originalSignature = transaction.input.signature;
      originalSenderOutput = transaction.outputMap[senderWallet.publicKey];
      nexReceiver = "Dylan";
      nextAmount = 50;
      transaction.update({
        senderWallet,
        receiver: nexReceiver,
        amount: nextAmount
      });
    });
    it("outputs the amount to the next receiver", () => {
      expects(transaction.outputMap[nexReceiver]).toEqual(nextAmount);
    });
    it("substracts the amount from the original sender output amount", () => {
      expects(transaction.outputMap[senderWallet.publicKey]).toEqual(originalSenderOutput - nextAmount);
    });
    it("maintains a total output that matches the input amount", () => {
      expect(Object.values(transaction.outputMap).reduce((total, outputAmount) => total + outputAmount)).toEqual(transaction.input.amount);
    });
    it("resigns the transaction", () => {
      expect(transaction.input.signature).not.toEqual(originalSignature);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYW5zYWN0aW9uLnRlc3QuanMiXSwibmFtZXMiOlsiVHJhbnNhY3Rpb24iLCJyZXF1aXJlIiwiV2FsbGV0IiwidmVyaWZ5U2lnbmF0dXJlIiwiZGVzY3JpYmUiLCJ0cmFuc2FjdGlvbiIsInNlbmRlcldhbGxldCIsInJlY2VpdmVyIiwiYW1vdW50IiwiYmVmb3JlRWFjaCIsIml0IiwiZXhwZWN0IiwidG9IYXZlUHJvcGVydHkiLCJvdXRwdXRNYXAiLCJ0b0VxdWFsIiwicHVibGljS2V5IiwiYmFsYW5jZSIsImlucHV0IiwiYWRkcmVzcyIsImRhdGEiLCJzaWduYXR1cmUiLCJ0b0JlIiwiZXJyb3JNb2NrIiwiamVzdCIsImZuIiwiZ2xvYmFsIiwiY29uc29sZSIsImVycm9yIiwidmFsaWRhdGVUcmFuc2FjdGlvbiIsInRvSGF2ZUJlZW5DYWxsZWQiLCJzaWduIiwib3JpZ2luYWxTaWduYXR1cmUiLCJvcmlnaW5hbFNlbmRlck91dHB1dCIsIm5leFJlY2VpdmVyIiwibmV4dEFtb3VudCIsInVwZGF0ZSIsImV4cGVjdHMiLCJPYmplY3QiLCJ2YWx1ZXMiLCJyZWR1Y2UiLCJ0b3RhbCIsIm91dHB1dEFtb3VudCIsIm5vdCJdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsNkJBQUQsQ0FBM0I7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FBdEI7O0FBQ0EsTUFBTTtBQUFFRSxFQUFBQTtBQUFGLElBQXNCRixPQUFPLENBQUMsVUFBRCxDQUFuQzs7QUFDQUcsUUFBUSxDQUFDLGFBQUQsRUFBZ0IsTUFBTTtBQUM1QixNQUFJQyxXQUFKLEVBQWlCQyxZQUFqQixFQUErQkMsUUFBL0IsRUFBeUNDLE1BQXpDO0FBRUFDLEVBQUFBLFVBQVUsQ0FBQyxNQUFNO0FBQ2ZILElBQUFBLFlBQVksR0FBRyxJQUFJSixNQUFKLEVBQWY7QUFDQUssSUFBQUEsUUFBUSxHQUFHLG9CQUFYO0FBQ0FDLElBQUFBLE1BQU0s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WUFBUixLQUF5QkQsS0FBSyxHQUFHQyxZQURuQyxDQURJLENBQU4sQ0FJRTNCLE9BSkYsQ0FJVVQsV0FBVyxDQUFDWSxLQUFaLENBQWtCVCxNQUo1QjtBQUtELEtBTkMsQ0FBRjtBQVFBRSxJQUFBQSxFQUFFLENBQUMseUJBQUQsRUFBNEIsTUFBTTtBQUNsQ0MsTUFBQUEsTUFBTSxDQUFDTixXQUFXLENBQUNZLEtBQVosQ0FBa0JHLFNBQW5CLENBQU4sQ0FBb0NzQixHQUFwQyxDQUF3QzVCLE9BQXhDLENBQWdEaUIsaUJBQWhEO0FBQ0QsS0FGQyxDQUFGO0FBR0QsR0FwQ08sQ0FBUjtBQXFDRCxDQW5JTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgVHJhbnNhY3Rpb24gPSByZXF1aXJlKFwiLi4vd2FsbGV0L3RyYW5zYWN0aW9uL2luZGV4XCIpO1xyXG5jb25zdCBXYWxsZXQgPSByZXF1aXJlKFwiLi4vd2FsbGV0L2luZGV4XCIpO1xyXG5jb25zdCB7IHZlcmlmeVNpZ25hdHVyZSB9ID0gcmVxdWlyZShcIi4uL3V0aWxzXCIpO1xyXG5kZXNjcmliZShcIlRyYW5zYWN0aW9uXCIsICgpID0+IHtcclxuICBsZXQgdHJhbnNhY3Rpb24sIHNlbmRlcldhbGxldCwgcmVjZWl2ZXIsIGFtb3VudDtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICBzZW5kZXJXYWxsZXQgPSBuZXcgV2FsbGV0KCk7XHJcbiAgICByZWNlaXZlciA9IFwicmVjZWl2ZXItcHVibGljS2V5XCI7XHJcbiAgICBhbW91bnQgPSAyMDtcclxuICAgIHRyYW5zYWN0aW9uID0gbmV3IFRyYW5zYWN0aW9uKHsgc2VuZGVyV2FsbGV0LCByZWNlaXZlciwgYW1vdW50IH0pO1xyXG4gIH0pO1xyXG5cclxuICBpdChcImhhcyBhbiBgaWRgXCIsICgpID0+IHtcclxuICAgIGV4cGVjdCh0cmFuc2FjdGlvbikudG9IYXZlUHJvcGVydHkoXCJpZFwiKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoXCJvdXRwdXRNYXBcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJoYXMgYW4gb3V0cHV0TWFwXCIsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHRyYW5zYWN0aW9uKS50b0hhdmVQcm9wZXJ0eShcIm91dHB1dE1hcFwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwib3V0cHV0cyBhbW91bnQgb2YgcmVjZWl2ZXJcIiwgKCkgPT4ge1xyXG4gICAgICBleHBlY3QodHJhbnNhY3Rpb24ub3V0cHV0TWFwW3JlY2VpdmVyXSkudG9FcXVhbChhbW91bnQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJvdXRwdXRzIHRoZSByZW1haW5pbmcgYmFsYW5jZSBvZiB0aGUgc2VuZGVyXCIsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHRyYW5zYWN0aW9uLm91dHB1dE1hcFtzZW5kZXJXYWxsZXQucHVibGljS2V5XSkudG9FcXVhbChcclxuICAgICAgICBzZW5kZXJXYWxsZXQuYmFsYW5jZSAtIGFtb3VudFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKFwiaW5wdXRcIiwgKCkgPT4ge1xyXG4gICAgaXQoXCJoYXMgYW4gYGlucHV0YFwiLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdCh0cmFuc2FjdGlvbikudG9IYXZlUHJvcGVydHkoXCJpbnB1dFwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiaGFzIGB0aW1lc3RhbXBgIGluIHRoZSBgaW5wdXRgXCIsICgpID0+IHtcclxuICAgICAgZXhwZWN0KHRyYW5zYWN0aW9uLmlucHV0KS50b0hhdmVQcm9wZXJ0eShcInRpbWVzdGFtcFwiKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2V0cyB0aGUgYGFtb3VudGAgdG8gdGhlIGBzZW5kZXJXYWxsZXRgIGJhbGFuY2VcIiwgKCkgPT4ge1xyXG4gICAgICBleHBlY3QodHJhbnNhY3Rpb24uaW5wdXQuYW1vdW50KS50b0VxdWFsKHNlbmRlcldhbGxldC5iYWxhbmNlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2V0cyB0aGUgYGFkZHJlc3NgIHRvIHRoZSBgc2VuZGVyV2FsbGV0YCBwdWJsaWNLZXlcIiwgKCkgPT4ge1xyXG4gICAgICBleHBlY3QodHJhbnNhY3Rpb24uaW5wdXQuYWRkcmVzcykudG9FcXVhbChzZW5kZXJXYWxsZXQucHVibGljS2V5KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic2lnbnMgdGhlIGlucHV0XCIsICgpID0+IHtcclxuICAgICAgZXhwZWN0KFxyXG4gICAgICAgIHZlcmlmeVNpZ25hdHVyZSh7XHJcbiAgICAgICAgICBwdWJsaWNLZXk6IHNlbmRlcldhbGxldC5wdWJsaWNLZXksXHJcbiAgICAgICAgICBkYXRhOiB0cmFuc2FjdGlvbi5vdXRwdXRNYXAsXHJcbiAgICAgICAgICBzaWduYXR1cmU6IHRyYW5zYWN0aW9uLmlucHV0LnNpZ25hdHVyZVxyXG4gICAgICAgIH0pXHJcbiAgICAgICkudG9CZSh0cnVlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZShcInZhbGlkYXRlVHJhbnNhY3Rpb24oKVwiLCAoKSA9PiB7XHJcbiAgICBsZXQgZXJyb3JNb2NrO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICBlcnJvck1vY2sgPSBqZXN0LmZuKCk7XHJcblxyXG4gICAgICBnbG9iYWwuY29uc29sZS5lcnJvciA9IGVycm9yTW9jaztcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKFwid2hlbiB0aGUgdHJhbnNhY3Rpb24gaXMgdmFsaWRcIiwgKCkgPT4ge1xyXG4gICAgICBpdChcInJldHVybnMgdHJ1ZVwiLCAoKSA9PiB7XHJcbiAgICAgICAgZXhwZWN0KFRyYW5zYWN0aW9uLnZhbGlkYXRlVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24pKS50b0JlKHRydWUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKFwid2hlbiB0aGUgdHJhbnNhY3Rpb24gaXMgaW52YWxpZFwiLCAoKSA9PiB7XHJcbiAgICAgIGRlc2NyaWJlKFwiYW5kIHRoZSB0cmFuc2FjdGlvbiBvdXRwdXRtYXAgdmFsdWUgaXMgaW52YWxpZFwiLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoXCJyZXR1cm5zIGZhbHNlIGFuZCBsb2dzIGFuIGVycm9yXCIsICgpID0+IHtcclxuICAgICAgICAgIHRyYW5zYWN0aW9uLm91dHB1dE1hcFtzZW5kZXJXYWxsZXQucHVibGljS2V5XSA9IDk5OTk5OTtcclxuXHJcbiAgICAgICAgICBleHBlY3QoVHJhbnNhY3Rpb24udmFsaWRhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbikpLnRvQmUoZmFsc2UpO1xyXG4gICAgICAgICAgZXhwZWN0KGVycm9yTW9jaykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGRlc2NyaWJlKFwiYW5kIHRoZSB0cmFuc2FjdGlvbiBpbnB1dCBzaWduYXR1cmUgaXMgaW52YWxpZFwiLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoXCJyZXR1cm5zIGZhbHNlIGFuZCBsb2dzIGFuIGVycm9yXCIsICgpID0+IHtcclxuICAgICAgICAgIHRyYW5zYWN0aW9uLmlucHV0LnNpZ25hdHVyZSA9IG5ldyBXYWxsZXQoKS5zaWduKFwiZGF0YVwiKTtcclxuXHJcbiAgICAgICAgICBleHBlY3QoVHJhbnNhY3Rpb24udmFsaWRhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbikpLnRvQmUoZmFsc2UpO1xyXG4gICAgICAgICAgZXhwZWN0KGVycm9yTW9jaykudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZShcInVwZGF0ZSgpXCIsICgpID0+IHtcclxuICAgIGxldCBvcmlnaW5hbFNpZ25hdHVyZSwgb3JpZ2luYWxTZW5kZXJPdXRwdXQsIG5leFJlY2VpdmVyLCBuZXh0QW1vdW50O1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICBvcmlnaW5hbFNpZ25hdHVyZSA9IHRyYW5zYWN0aW9uLmlucHV0LnNpZ25hdHVyZTtcclxuICAgICAgb3JpZ2luYWxTZW5kZXJPdXRwdXQgPSB0cmFuc2FjdGlvbi5vdXRwdXRNYXBbc2VuZGVyV2FsbGV0LnB1YmxpY0tleV07XHJcbiAgICAgIG5leFJlY2VpdmVyID0gXCJEeWxhblwiO1xyXG4gICAgICBuZXh0QW1vdW50ID0gNTA7XHJcblxyXG4gICAgICB0cmFuc2FjdGlvbi51cGRhdGUoe1xyXG4gICAgICAgIHNlbmRlcldhbGxldCxcclxuICAgICAgICByZWNlaXZlcjogbmV4UmVjZWl2ZXIsXHJcbiAgICAgICAgYW1vdW50OiBuZXh0QW1vdW50XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICBpdChcIm91dHB1dHMgdGhlIGFtb3VudCB0byB0aGUgbmV4dCByZWNlaXZlclwiLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdHModHJhbnNhY3Rpb24ub3V0cHV0TWFwW25leFJlY2VpdmVyXSkudG9FcXVhbChuZXh0QW1vdW50KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwic3Vic3RyYWN0cyB0aGUgYW1vdW50IGZyb20gdGhlIG9yaWdpbmFsIHNlbmRlciBvdXRwdXQgYW1vdW50XCIsICgpID0+IHtcclxuICAgICAgZXhwZWN0cyh0cmFuc2FjdGlvbi5vdXRwdXRNYXBbc2VuZGVyV2FsbGV0LnB1YmxpY0tleV0pLnRvRXF1YWwoXHJcbiAgICAgICAgb3JpZ2luYWxTZW5kZXJPdXRwdXQgLSBuZXh0QW1vdW50XHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcIm1haW50YWlucyBhIHRvdGFsIG91dHB1dCB0aGF0IG1hdGNoZXMgdGhlIGlucHV0IGFtb3VudFwiLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdChcclxuICAgICAgICBPYmplY3QudmFsdWVzKHRyYW5zYWN0aW9uLm91dHB1dE1hcCkucmVkdWNlKFxyXG4gICAgICAgICAgKHRvdGFsLCBvdXRwdXRBbW91bnQpID0+IHRvdGFsICsgb3V0cHV0QW1vdW50XHJcbiAgICAgICAgKVxyXG4gICAgICApLnRvRXF1YWwodHJhbnNhY3Rpb24uaW5wdXQuYW1vdW50KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwicmVzaWducyB0aGUgdHJhbnNhY3Rpb25cIiwgKCkgPT4ge1xyXG4gICAgICBleHBlY3QodHJhbnNhY3Rpb24uaW5wdXQuc2lnbmF0dXJlKS5ub3QudG9FcXVhbChvcmlnaW5hbFNpZ25hdHVyZSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdfQ==